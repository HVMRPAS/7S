<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>7S-RAPPORT MRPAS</title>

  <!-- jsPDF fÃ¶r PDF-export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root {
      --bg: #f7f7f7;
      --card: #ffffff;
      --primary: #0f5132;
      --text: #222;
      --muted: #666;
      --border: #dcdcdc;
      --accent: #2a6f3e;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      line-height: 1.4;
    }

    .container {
      max-width: 780px;
      margin: 0 auto;
      padding: 16px;
    }

    header.header {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 12px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
    }

    .header-img {
      max-width: 150px;
      height: auto;
      object-fit: contain;
      border-radius: 8px;
    }

    h1 {
      font-size: 1.6rem;
      color: var(--primary);
      margin: 0;
    }

    form {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-top: 16px;
    }

    fieldset {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px;
      margin: 10px 0 14px;
      background: #fff;
    }

    legend {
      font-weight: 600;
      color: var(--primary);
      padding: 0 6px;
    }

    small {
      color: var(--muted);
      display: block;
      margin-bottom: 8px;
    }

    .row {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
      align-items: start;
    }

    textarea {
      font-size: 1.2em;
      padding: 16px;
      border-radius: 8px;
      border: 1px solid var(--border);
      width: 100%;
      background: #fafafa;
    }

    #spaningsfraga {
      font-size: 1.2em;
      padding: 32px;
      min-height: 200px;
      background: #f5fff7;
      border-color: #cfe6d5;
    }

    button {
      appearance: none;
      border: 1px solid var(--border);
      background: #fff;
      padding: 10px 14px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }

    button.primary {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }

    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    pre#output {
      background: #111;
      color: #d6f3da;
      padding: 12px;
      border-radius: 10px;
      overflow: auto;
      border: 1px solid #333;
      min-height: 120px;
      font-size: 0.95em;
    }

    .footer-note {
      color: var(--muted);
      font-size: 0.9em;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <img src="mrpas-operator.png" alt="MRPAS OperatÃ¶r" class="header-img" />
      <h1>7S-RAPPORT RPAS</h1>
    </header>

    <form id="rapportForm" onsubmit="return false;">
      <!-- SpaningsfrÃ¥ga -->
      <fieldset>
        <legend>ğŸ¯ SpaningsfrÃ¥ga</legend>
        <small>Vad vill vi fÃ¥ svar pÃ¥ med denna spaning?</small>
        <div class="row">
          <textarea id="spaningsfraga" placeholder="Beskriv uppgiften/NAI/PRI..."></textarea>
          <button type="button" onclick="startVoiceForField('spaningsfraga')">ğŸ¤</button>
        </div>
      </fieldset>

      <!-- 1. Stund -->
      <fieldset>
        <legend>1. ğŸ•’ Stund</legend>
        <small>Tidpunkt â€“ NÃ¤r observationen gjordes</small>
        <div class="row">
          <textarea id="stund" placeholder="Ex: 121500Z"></textarea>
          <button type="button" onclick="startVoiceForField('stund')">ğŸ¤</button>
        </div>
      </fieldset>

      <!-- 2. StÃ¤lle -->
      <fieldset>
        <legend>2. ğŸ“ StÃ¤lle</legend>
        <small>Plats â€“ Var observationen gjordes</small>
        <div class="row">
          <textarea id="stalle" placeholder="Ex: MGRS 33V XH 1234 5678"></textarea>
          <button type="button" onclick="startVoiceForField('stalle')">ğŸ¤</button>
        </div>
      </fieldset>

      <!-- 3. Styrka -->
      <fieldset>
        <legend>3. ğŸ‘¥ Styrka</legend>
        <small>Antal â€“ Hur mÃ¥nga som observerades</small>
        <div class="row">
          <textarea id="styrka" placeholder="Ex: 2 fordon, 6 personer"></textarea>
          <button type="button" onclick="startVoiceForField('styrka')">ğŸ¤</button>
        </div>
      </fieldset>

      <!-- 4. Slag -->
      <fieldset>
        <legend>4. ğŸš› Slag</legend>
        <small>Typ â€“ Modell av fordon, truppslag eller hÃ¤ndelsetyp</small>
        <div class="row">
          <textarea id="slag" placeholder="Ex: pansarterrÃ¤ngbil, infanteri"></textarea>
          <button type="button" onclick="startVoiceForField('slag')">ğŸ¤</button>
        </div>
      </fieldset>

      <!-- 5. SysselsÃ¤ttning -->
      <fieldset>
        <legend>5. âš™ï¸ SysselsÃ¤ttning</legend>
        <small>Aktivitet â€“ Vad de gjorde</small>
        <div class="row">
          <textarea id="sysselsattning" placeholder="Ex: lastar materiel"></textarea>
          <button type="button" onclick="startVoiceForField('sysselsattning')">ğŸ¤</button>
        </div>
      </fieldset>

      <!-- 6. Symbol -->
      <fieldset>
        <legend>6. ğŸ·ï¸ Symbol</legend>
        <small>MÃ¤rkning â€“ Nummer, fÃ¤rg, emblem</small>
        <div class="row">
          <textarea id="symbol" placeholder="Ex: blÃ¥ markering"></textarea>
          <button type="button" onclick="startVoiceForField('symbol')">ğŸ¤</button>
        </div>
      </fieldset>

      <!-- 7. Sagesman -->
      <fieldset>
        <legend>7. ğŸ§‘â€âœˆï¸ Sagesman</legend>
        <small>Vem â€“ Vem som gjort iakttagelsen</small>
        <div class="row">
          <textarea id="sagesman" placeholder="Ex: RPAS operatÃ¶r Alfa"></textarea>
          <button type="button" onclick="startVoiceForField('sagesman')">ğŸ¤</button>
        </div>
      </fieldset>

      <!-- Bilaga -->
      <fieldset>
        <legend>ğŸ“ Bilaga</legend>
        <small>Bifoga en bild eller fil</small>
        <input type="file" id="bilaga" accept="image/*,.pdf,.doc,.txt" />
      </fieldset>

      <div class="actions">
        <button type="button" class="primary" onclick="exportReport()">ğŸ“¤ Exportera rapport</button>
      </div>
    </form>

    <h2 style="margin-top:16px;">Export</h2>
    <div class="actions" id="shareActions"></div>
    <pre id="output"></pre>
    <div class="footer-note">Tip: Efter export, anvÃ¤nd knapparna fÃ¶r Mail, SMS, Utskrift eller PDF.</div>
  </div>

  <script>
    function getNextReportNumber() {
      let current = localStorage.getItem("reportCounter");
      current = current ? parseInt(current, 10) + 1 : 1000;
      localStorage.setItem("reportCounter", current);
      return current;
    }

    function generateReportId() {
      return `RPAS_${getNextReportNumber()}`;
    }

    function startVoiceForField(fieldId) {
      try {
        const recognition = new webkitSpeechRecognition();
        recognition.lang = "sv-SE";
        recognition.start();
        recognition.onresult = function(event) {
          const text = event.results[0][0].transcript;
          const el = document.getElementById(fieldId);
          el.value = (el.value ? el.value + " " : "") + text;
        };
      } catch (e) {
        alert("RÃ¶stinmatning stÃ¶ds inte i denna webblÃ¤sare.");
      }
    }

    function exportReport() {
      const rapport = {
        id: generateReportId(),
        spaningsfraga: document.getElementById("spaningsfraga").value.trim(),
        stund: document.getElementById("stund").value.trim(),
        stalle: document.getElementById("stalle").value.trim(),
        styrka: document.getElementById("styrka").value.trim(),
        slag: document.getElementById("slag").value.trim(),
        sysselsattning: document.getElementById("sysselsattning").value.trim(),
        symbol: document.getElementById("symbol").value.trim(),
        sagesman: document.getElementById("sagesman").value.trim(),
        timestamp: new Date().toISOString(),
        bilaga: document.getElementById("bilaga").files.length > 0 ? document.getElementById("bilaga").files[0].name : "Ingen"
      };

      document.getElementById("output").textContent = JSON.stringify(rapport, null, 2);
      createShareButtons(rapport);
    }

    function formatReportText(rapport) {
      return `
ğŸ›°ï¸ 7S-RAPPORT MRPAS
ğŸ“Œ ID: ${rapport.id}
ğŸ“… Tidpunkt: ${rapport.stund}
ğŸ“ Plats: ${rapport.stalle}
ğŸ‘¥ Styrka: ${rapport.styrka}
ğŸš› Typ: ${rapport.slag}
âš™ï¸ Aktivitet: ${rapport.sysselsattning}
ğŸ·ï¸ MÃ¤rkning: ${rapport.symbol}
ğŸ§‘â€âœˆï¸ Sagesman: ${rapport.sagesman}

ğŸ¯ SpaningsfrÃ¥ga:
${rapport.spaningsfraga}

ğŸ“ Bilaga: ${rapport.bilaga}
ğŸ•“ Skapad: ${rapport.timestamp}
`.trim();
    }

    function createShareButtons(rapport) {
      const share = document.getElementById("shareActions");
      share.innerHTML = "";
      const rapportText = formatReportText(rapport);

      const mailBtn = document.createElement("button");
      mailBtn.textContent = "ğŸ“§ Maila";
      mailBtn.onclick = () => window.location.href = `mailto:?subject=7S-RAPPORT ${rapport.id}&body=${encodeURIComponent(rapportText)}`;

      const smsBtn = document.createElement("button");
      smsBtn.textContent = "ğŸ“± SMS";
      smsBtn.onclick = () => window.location.href = `sms:?body=${encodeURIComponent(rapportText)}`;

      const printBtn = document.createElement("button");
      printBtn.textContent = "ğŸ–¨ï¸ Skriv ut";
      printBtn.onclick = () => {
        const win = window.open("", "", "width=800,height=900");
        win.document.write(`<pre style="font-family:monospace;white-space:pre-wrap;">${rapportText}</pre>`);
        win.document.close();
        win.focus();
        win.print();
      };

      const pdfBtn = document.createElement("button");
      pdfBtn.textContent = "ğŸ“„ PDF";
      pdfBtn.onclick = () => exportPDF(rapport);

      share.append(mailBtn, smsBtn, printBtn, pdfBtn);
    }

    function exportPDF(rapport) {
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const headerImg = document.querySelector(".header-img");
        const src = headerImg ? headerImg.src : null;

        if (!src) {
          drawPdfContent(doc, rapport, null);
          doc.save(`${rapport.id}.pdf`);
        } else {
          const img = new Image();
          img.crossOrigin = "anonymous";
          img.src = src;
          img.onload = function() {
            drawPdfContent(doc, rapport, img);
            doc.save(`${rapport.id}.pdf`);
          };
          img.onerror = function() {
            drawPdfContent(doc, rapport, null);
            doc.save(`${rapport.id}.pdf`);
          };
        }
      } catch (e) {
        alert("PDF-export misslyckades: " + e.message);
      }
    }

    function drawPdfContent(doc, rapport, img) {
      if (img) doc.addImage(img, "PNG", 10, 10, 30, 30);
      doc.setFontSize(18);
      doc.text("7S-RAPPORT RPAS", 46, 20);
      doc.setFontSize(12);
      let y = 50;
      const line = (label, value) => { doc.text(`${label}: ${value || "-"}`, 10, y); y += 8; };
      line("ID", rapport.id);
      line("Tidpunkt", rapport.stund);
      line("Plats", rapport.stalle);
      line("Styrka", rapport.styrka);
      line("Typ", rapport.slag);
      line("Aktivitet", rapport.sysselsattning);
      line("MÃ¤rkning", rapport.symbol);
      line("Sagesman", rapport.sagesman);
      doc.text("SpaningsfrÃ¥ga:", 10, y + 4);
      doc.text(rapport.spaningsfraga || "-", 10, y + 12, { maxWidth: 190 });
      y += 28;
      line("Bilaga", rapport.bilaga);
      line("Skapad", rapport.timestamp);
    }
  </script>
</body>
</html>
