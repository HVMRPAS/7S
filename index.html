<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>7S-RAPPORT MRPAS</title>
<script src="https://unpkg.com/mgrs@1.0.0/mgrs.js"></script>

  <!-- jsPDF fÃ¶r PDF-export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root {
      --bg: #f7f7f7;
      --card: #ffffff;
      --primary: #0f5132;
      --text: #222;
      --muted: #666;
      --border: #dcdcdc;
      --accent: #2a6f3e;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      line-height: 1.4;
    }

    .container {
      max-width: 780px;
      margin: 0 auto;
      padding: 16px;
    }

    header.header {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 12px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
    }

    .header-img {
      max-width: 150px;
      height: auto;
      object-fit: contain;
      border-radius: 8px;
    }

    h1 {
      font-size: 1.6rem;
      color: var(--primary);
      margin: 0;
    }

    form {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-top: 16px;
    }

    fieldset {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px;
      margin: 10px 0 14px;
      background: #fff;
    }

    legend {
      font-weight: 600;
      color: var(--primary);
      padding: 0 6px;
    }

    small {
      color: var(--muted);
      display: block;
      margin-bottom: 8px;
    }

    .row {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
      align-items: start;
    }

    textarea, input[type="text"] {
      font-size: 1.1em;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      width: 100%;
      background: #fafafa;
    }

    #spaningsfraga {
      font-size: 1.2em;
      padding: 24px;
      min-height: 160px;
      background: #f5fff7;
      border-color: #cfe6d5;
    }

    button {
      appearance: none;
      border: 1px solid var(--border);
      background: #fff;
      padding: 10px 14px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }

    button.primary {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }

    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    pre#output {
      background: #111;
      color: #d6f3da;
      padding: 12px;
      border-radius: 10px;
      overflow: auto;
      border: 1px solid #333;
      min-height: 120px;
      font-size: 0.95em;
    }

    .footer-note {
      color: var(--muted);
      font-size: 0.9em;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <img src="mrpas-operator.png" alt="MRPAS OperatÃ¶r" class="header-img" />
      <h1>7S-RAPPORT RPAS</h1>
    </header>

    <form id="rapportForm" onsubmit="return false;">
      <!-- SpaningsfrÃ¥ga -->
      <fieldset>
        <legend>ğŸ¯ SpaningsfrÃ¥ga</legend>
        <small>Vad vill vi fÃ¥ svar pÃ¥ med denna spaning?</small>
        <div class="row">
          <textarea id="spaningsfraga" placeholder="Beskriv uppgiften/NAI/PRI..."></textarea>
          <button type="button" onclick="startVoiceForField('spaningsfraga')">ğŸ¤</button>
        </div>
      </fieldset>

      <!-- Originala 7S -->
      <fieldset><legend>1. ğŸ•’ Stund</legend><small>Tidpunkt</small><div class="row"><textarea id="stund"></textarea><button type="button" onclick="startVoiceForField('stund')">ğŸ¤</button></div></fieldset>
      <fieldset><legend>2. ğŸ“ StÃ¤lle</legend><small>Plats</small><div class="row"><textarea id="stalle"></textarea><button type="button" onclick="startVoiceForField('stalle')">ğŸ¤</button></div></fieldset>
      <fieldset><legend>3. ğŸ‘¥ Styrka</legend><small>Antal</small><div class="row"><textarea id="styrka"></textarea><button type="button" onclick="startVoiceForField('styrka')">ğŸ¤</button></div></fieldset>
      <fieldset><legend>4. ğŸš› Slag</legend><small>Typ</small><div class="row"><textarea id="slag"></textarea><button type="button" onclick="startVoiceForField('slag')">ğŸ¤</button></div></fieldset>
      <fieldset><legend>5. âš™ï¸ SysselsÃ¤ttning</legend><small>Aktivitet</small><div class="row"><textarea id="sysselsattning"></textarea><button type="button" onclick="startVoiceForField('sysselsattning')">ğŸ¤</button></div></fieldset>
      <fieldset><legend>6. ğŸ·ï¸ Symbol</legend><small>MÃ¤rkning</small><div class="row"><textarea id="symbol"></textarea><button type="button" onclick="startVoiceForField('symbol')">ğŸ¤</button></div></fieldset>
      <fieldset><legend>7. ğŸ§‘â€âœˆï¸ Sagesman</legend><small>Vem</small><div class="row"><textarea id="sagesman"></textarea><button type="button" onclick="startVoiceForField('sagesman')">ğŸ¤</button></div></fieldset>

      <!-- Extra fÃ¤lt fÃ¶r RPAS -->
      <fieldset><legend>ğŸ“¡ HÃ¶jd</legend><small>Ange flyghÃ¶jd (m AGL)</small><input type="text" id="hojd" placeholder="Ex: 120 m" /></fieldset>
      <fieldset><legend>ğŸŒ¤ VÃ¤der</legend><small>Ex: Vind, temp, molnighet</small><textarea id="vader" placeholder="Ex: Vind 5 m/s, temp 10Â°C"></textarea></fieldset>
      <fieldset><legend>ğŸ‘ Sikt</legend><small>Visuell/IR</small><input type="text" id="sikt" placeholder="Ex: god, IR begrÃ¤nsad" /></fieldset>
      <fieldset><legend>ğŸ¥ SensorlÃ¤ge</legend><small>EO, IR, Termisk</small><input type="text" id="sensorlage" placeholder="Ex: EO + IR" /></fieldset>
      <fieldset><legend>ğŸ” Sensorprestanda</legend><small>Zoom, upplÃ¶sning</small><input type="text" id="sensorprestanda" placeholder="Ex: Zoom x10, termisk OK" /></fieldset>
<fieldset>
  <legend>ğŸ“ Plats av intresse (MGRS)</legend>
  <input type="text" id="mgrs" placeholder="Ex: 33V XH 12345 67890" />
  <button onclick="openMGRS()">Ã–ppna i Google Maps</button>
</fieldset>

      <!-- Bilaga -->
      <fieldset>
        <legend>ğŸ“ Bilaga</legend>
        <small>Bifoga en bild eller fil</small>
        <input type="file" id="bilaga" accept="image/*,.pdf,.doc,.txt" />
      </fieldset>

      <div class="actions">
        <button type="button" class="primary" onclick="exportReport()">ğŸ“¤ Exportera rapport</button>
      </div>
    </form>

    <h2 style="margin-top:16px;">Export</h2>
    <div class="actions" id="shareActions"></div>
    <pre id="output"></pre>
    <div class="footer-note">Tip: Efter export, anvÃ¤nd knapparna fÃ¶r Mail, SMS, Utskrift eller PDF.</div>
  </div>

  <script>
    function getNextReportNumber() {
      let current = localStorage.getItem("reportCounter");
      current = current ? parseInt(current, 10) + 1 : 1000;
      localStorage.setItem("reportCounter", current);
      return current;
    }

    function generateReportId() {
      return `RPAS_${getNextReportNumber()}`;
    }

    function startVoiceForField(fieldId) {
      try {
        const recognition = new webkitSpeechRecognition();
        recognition.lang = "sv-SE";
        recognition.start();
        recognition.onresult = function(event) {
          const text = event.results[0][0].transcript;
          const el = document.getElementById(fieldId);
          el.value = (el.value ? el.value + " " : "") + text;
        };
      } catch (e) {
        alert("RÃ¶stinmatning stÃ¶ds inte i denna webblÃ¤sare.");
      }
    }

    function exportReport() {
      const rapport = {
        id: generateReportId(),
        spaningsfraga: document.getElementById("spaningsfraga").value.trim(),
        stund: document.getElementById("stund").value.trim(),
        stalle: document.getElementById("stalle").value.trim(),
        styrka: document.getElementById("styrka").value.trim(),
        slag: document.getElementById("slag").value.trim(),
        sysselsattning: document.getElementById("sysselsattning").value.trim(),
        symbol: document.getElementById("symbol").value.trim(),
        sagesman: document.getElementById("sagesman").value.trim(),
        hojd: document.getElementById("hojd").value.trim(),
        vader: document.getElementById("vader").value.trim(),
        sikt: document.getElementById("sikt").value.trim(),
        sensorlage: document.getElementById("sensorlage").value.trim(),
        sensorprestanda: document.getElementById("sensorprestanda").value.trim(),
        timestamp: new Date().toISOString(),
        bilaga: document.getElementById("bilaga").files.length > 0 ? document.getElementById("bilaga").files[0].name : "Ingen"
      };

      document.getElementById("output").textContent = JSON.stringify(rapport, null, 2);
      createShareButtons(rapport);
    }

    function formatReportText(rapport) {
      return `
ğŸ›°ï¸ 7S-RAPPORT MRPAS
ğŸ“Œ ID: ${rapport.id}
ğŸ“… Tidpunkt: ${rapport.stund}
ğŸ“ Plats: ${rapport.stalle}
ğŸ‘¥ Styrka: ${rapport.styrka}
ğŸš› Typ: ${rapport.slag}
âš™ï¸ Aktivitet: ${rapport.sysselsattning}
ğŸ·ï¸ MÃ¤rkning: ${rapport.symbol}
ğŸ§‘â€âœˆï¸ Sagesman: ${rapport.sagesman}

ğŸ“¡ HÃ¶jd: ${rapport.hojd}
ğŸŒ¤ VÃ¤der: ${rapport.vader}
ğŸ‘ Sikt: ${rapport.sikt}
ğŸ¥ SensorlÃ¤ge: ${rapport.sensorlage}
ğŸ” Sensorprestanda: ${rapport.sensorprestanda}

ğŸ¯ SpaningsfrÃ¥ga:
${rapport.spaningsfraga}

ğŸ“ Bilaga: ${rapport.bilaga}
ğŸ•“ Skapad: ${rapport.timestamp}
`.trim();
    }

    function createShareButtons(rapport) {
      const share = document.getElementById("shareActions");
      share.innerHTML = "";
      const rapportText = formatReportText(rapport);

      const mailBtn = document.createElement("button");
      mailBtn.textContent = "ğŸ“§ Maila";
      mailBtn.onclick = () => window.location.href = `mailto:?subject=7S-RAPPORT ${rapport.id}&body=${encodeURIComponent(rapportText)}`;

      const smsBtn = document.createElement("button");
      smsBtn.textContent = "ğŸ“± SMS";
      smsBtn.onclick = () => window.location.href = `sms:?body=${encodeURIComponent(rapportText)}`;

      const printBtn = document.createElement("button");
      printBtn.textContent = "ğŸ–¨ï¸ Skriv ut";
      printBtn.onclick = () => {
        const win = window.open("", "", "width=800,height=900");
        win.document.write(`<pre style="font-family:monospace;white-space:pre-wrap;">${rapportText}</pre>`);
        win.document.close();
        win.focus();
        win.print();
      };

      const pdfBtn = document.createElement("button");
      pdfBtn.textContent = "ğŸ“„ PDF";
      pdfBtn.onclick = () => exportPDF(rapport);

      share.append(mailBtn, smsBtn, printBtn, pdfBtn);
    }

    function exportPDF(rapport) {
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const headerImg = document.querySelector(".header-img");
        const src = headerImg ? headerImg.src : null;

        if (!src) {
          drawPdfContent(doc, rapport, null);
          doc.save(`${rapport.id}.pdf`);
        } else {
          const img = new Image();
          img.crossOrigin = "anonymous";
          img.src = src;
          img.onload = function() {
            drawPdfContent(doc, rapport, img);
            doc.save(`${rapport.id}.pdf`);
          };
          img.onerror = function() {
            drawPdfContent(doc, rapport, null);
            doc.save(`${rapport.id}.pdf`);
          };
        }
      } catch (e) {
        alert("PDF-export misslyckades: " + e.message);
      }
    }

    function drawPdfContent(doc, rapport, img) {
      if (img) doc.addImage(img, "PNG", 10, 10, 30, 30);
      doc.setFontSize(18);
      doc.text("7S-RAPPORT RPAS", 46, 20);
      doc.setFontSize(12);
      let y = 50;
      const line = (label, value) => { doc.text(`${label}: ${value || "-"}`, 10, y); y += 8; };
      line("ID", rapport.id);
      line("Tidpunkt", rapport.stund);
      line("Plats", rapport.stalle);
      line("Styrka", rapport.styrka);
      line("Typ", rapport.slag);
      line("Aktivitet", rapport.sysselsattning);
      line("MÃ¤rkning", rapport.symbol);
      line("Sagesman", rapport.sagesman);
      line("HÃ¶jd", rapport.hojd);
      line("VÃ¤der", rapport.vader);
      line("Sikt", rapport.sikt);
      line("SensorlÃ¤ge", rapport.sensorlage);
      line("Sensorprestanda", rapport.sensorprestanda);
      doc.text("SpaningsfrÃ¥ga:", 10, y + 4);
      doc.text(rapport.spaningsfraga || "-", 10, y + 12, { maxWidth: 190 });
      y += 28;
      line("Bilaga", rapport.bilaga);
      line("Skapad", rapport.timestamp);
    }
  </script>
</body>
</html>
